<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>COMERSUR | Cierre Semanal de Gestión</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container-fluid { padding: 20px; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        .table-container { background: white; border-radius: 8px; overflow: hidden; }
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .bg-error { background: #ffdada; color: #a30000; }
        .bg-success { background: #d4edda; color: #155724; }
        .header-section { background: #003366; color: white; padding: 20px; border-radius: 8px 8px 0 0; margin-bottom: 0; }
        .btn-sync { background: #107c41; color: white; font-weight: bold; }
        .btn-sync:hover { background: #0b5e31; color: white; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="card">
        <div class="header-section d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">CIERRE SEMANAL DE GESTIÓN</h4>
                <small>Conciliación de Cargo Plan vs. Planificación de DAEs</small>
            </div>
            <div class="d-flex gap-2">
                <input type="number" id="txtSemana" class="form-control form-control-sm" placeholder="Semana (ej. 8)">
                <button onclick="cargarCierre()" class="btn btn-sm btn-light">Analizar Cuadre</button>
            </div>
        </div>

        <div class="p-4">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light text-secondary">
                        <tr>
                            <th>BOOKING</th>
                            <th>CLIENTE / DESTINO</th>
                            <th>DAE</th>
                            <th class="text-center">PLANIFICADO (DAEs)</th>
                            <th class="text-center">REAL (CARGO PLAN)</th>
                            <th class="text-center">DIFERENCIA</th>
                            <th class="text-center">ESTADO</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cierre">
                        </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end mt-4 border-top pt-3">
                <button id="btnEjecutar" onclick="sincronizarPlanificacion()" class="btn btn-sync d-none">
                    Cerrar Semana y Ajustar Planificación
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    let dataParaSincronizar = [];

    async function cargarCierre() {
        const sem = document.getElementById('txtSemana').value;
        if(!sem) return alert("Indica la semana.");

        // 1. Obtener Realidad del Cargo Plan (distribucion_diaria)
        const { data: reales } = await _supabase.from('distribucion_diaria').select('*').eq('semana', sem);
        
        // 2. Obtener Planificación (reporte_daes)
        const bookings = [...new Set(reales.map(r => r.booking))].filter(Boolean);
        const { data: planificados } = await _supabase.from('reporte_daes').select('*').in('booking', bookings);

        // 3. Agrupar Cajas por Booking del Cargo Plan
        const resumenReal = {};
        reales.forEach(r => {
            const bk = r.booking.trim();
            if(!resumenReal[bk]) resumenReal[bk] = 0;
            resumenReal[bk] += parseInt(r.cajas || 0);
        });

        const tbody = document.getElementById('tabla-cierre');
        tbody.innerHTML = '';
        dataParaSincronizar = [];

        planificados.forEach(p => {
            const bk = p.booking.trim();
            const real = resumenReal[bk] || 0;
            const plan = parseInt(p.cajas_gestionadas || 0);
            const dif = plan - real;
            const cuadrado = dif === 0;

            dataParaSincronizar.push({ booking: bk, real: real });

            tbody.innerHTML += `
                <tr>
                    <td><strong>${bk}</strong></td>
                    <td>${p.cliente || 'N/A'}<br><small class="text-muted">${p.puerto_destino || p.destino || ''}</small></td>
                    <td>${p.dae || 'SIN DAE'}</td>
                    <td class="text-center">${plan.toLocaleString()}</td>
                    <td class="text-center">${real.toLocaleString()}</td>
                    <td class="text-center ${dif !== 0 ? 'text-danger fw-bold' : ''}">${dif}</td>
                    <td class="text-center">
                        <span class="status-badge ${cuadrado ? 'bg-success' : 'bg-error'}">
                            ${cuadrado ? 'CUADRADO' : 'DESCUADRADO'}
                        </span>
                    </td>
                </tr>
            `;
        });

        document.getElementById('btnEjecutar').classList.remove('d-none');
    }

    async function sincronizarPlanificacion() {
        if(!confirm("¿Seguro que desea cerrar la semana? Esto actualizará la planificación (cajas gestionadas) con los valores reales del Cargo Plan.")) return;

        try {
            for (let item of dataParaSincronizar) {
                // Actualizamos la tabla reporte_daes para que la planificación coincida con lo real
                await _supabase
                    .from('reporte_daes')
                    .update({ cajas_gestionadas: item.real })
                    .eq('booking', item.booking);
            }
            alert("Sincronización exitosa. La planificación ahora coincide con lo ejecutado.");
            cargarCierre();
        } catch (error) {
            console.error(error);
            alert("Error al sincronizar.");
        }
    }
</script>
</body>
</html>
