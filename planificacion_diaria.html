<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Planificación Diaria | Cargo Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-size: 11px; height: 100vh; display: flex; flex-direction: column; background: #f8f9fa; }
        .top-bar { background: #1d6f42; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .grid-container { flex: 1; overflow: auto; background: white; margin: 5px; border: 1px solid #ccc; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; }
        
        th { background: #e9ecef; position: sticky; top: 0; z-index: 10; border: 0.5px solid #bbb; padding: 5px; text-align: center; }
        td { border: 0.5px solid #ddd; padding: 3px 6px; white-space: nowrap; outline: none; text-overflow: ellipsis; overflow: hidden; cursor: cell; }
        
        /* Estados de Celda/Fila */
        td:focus { border: 2px solid #0d6efd !important; background: #e8f0fe !important; }
        .fila-seleccionada { background-color: #d1e7dd !important; outline: 2px solid #198754; }
        .booking-completado { background-color: #cff4fc !important; border-left: 5px solid #0dcaf0 !important; }
        
        .btn-sm { font-size: 10px; }
        .sticky-col { position: sticky; left: 0; background: #f8f9fa; z-index: 5; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <button class="btn btn-link text-white p-0 me-2" onclick="window.location.href='cargo_plan_semanal.html'">
            <i class="bi bi-arrow-left-circle-fill fs-5"></i>
        </button>
        <i class="bi bi-calendar3"></i> <b>PLANIFICACIÓN: <span id="txtDia">---</span></b> | 
        SEMANA: <span id="txtSem">---</span>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-light btn-sm" onclick="agregarFila()"><i class="bi bi-plus-lg"></i> Agregar Fila</button>
        <button class="btn btn-danger btn-sm" onclick="eliminarFila()"><i class="bi bi-trash"></i> Eliminar</button>
        <button class="btn btn-warning btn-sm fw-bold" onclick="guardarCambios()"><i class="bi bi-cloud-check"></i> GUARDAR CAMBIOS</button>
    </div>
</div>

<div class="grid-container">
    <table id="mainTable">
        <thead>
            <tr id="hRow">
                <th style="width: 40px;">#</th>
                </tr>
        </thead>
        <tbody id="bBody">
            <tr><td colspan="20" class="text-center py-5">Cargando datos...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // 1. CONFIGURACIÓN INICIAL
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const DIA = params.get('dia') || 'LUNES';
    const SEMANA = params.get('semana') || '0';

    document.getElementById('txtDia').innerText = DIA.toUpperCase();
    document.getElementById('txtSem').innerText = SEMANA;

    const columnas = ["EMPRESA", "PRODUCTOR", "FINCA", "BUQUE", "BOOKING", "CONTENEDOR", "SELLO_NAV", "SELLO_TCI", "SELLO_VENT", "SELLO_STICKER", "SELLO_STICKER_NAV", "TERMOGRAFO", "CHOFER", "CEDULA", "PLACA", "SUPERVISOR"];

    // 2. DIBUJAR CABECERA
    const hRow = document.getElementById('hRow');
    columnas.forEach(col => {
        let th = document.createElement('th');
        th.style.width = "130px";
        th.innerText = col.replace(/_/g, " ");
        hRow.appendChild(th);
    });

    // 3. FUNCIÓN DE CARGA (LA QUE NECESITABAS CONECTAR)
    async function cargarPlanificacion() {
        try {
            const { data, error } = await _supabase
                .from('distribucion_diaria')
                .select('*')
                .match({ semana: SEMANA, dia: DIA })
                .order('booking', { ascending: true });

            if (error) throw error;

            if (data && data.length > 0) {
                let buffer = "";
                data.forEach((reg, index) => {
                    buffer += crearFilaHTML(reg, index + 1);
                });
                document.getElementById('bBody').innerHTML = buffer;
                asignarColoresPorBooking();
            } else {
                document.getElementById('bBody').innerHTML = '<tr><td colspan="20" class="text-center py-5 text-muted">No hay datos. Importe un Excel primero.</td></tr>';
            }
        } catch (err) {
            alert("Error al cargar: " + err.message);
        }
    }

    // 4. GENERACIÓN DE FILAS
    function crearFilaHTML(reg = {}, num) {
        let fila = `<tr><td class="sticky-col text-center bg-light">${num}</td>`;
        columnas.forEach(col => {
            let val = reg[col.toLowerCase()] || "";
            fila += `<td contenteditable="true" data-col="${col.toLowerCase()}">${val}</td>`;
        });
        fila += `</tr>`;
        return fila;
    }

    // 5. LÓGICA DE INTERACCIÓN (ENTER, DOBLE CLICK, TRIPLE CLICK)
    document.getElementById('bBody').addEventListener('keydown', function(e) {
        const cell = e.target;
        const row = cell.parentElement;
        const rowIndex = row.rowIndex - 1;
        const colIndex = cell.cellIndex;

        if (e.key === "Enter") {
            e.preventDefault();
            // Lógica Doble Enter: Selecciona fila
            if (cell.dataset.lastEnter && (Date.now() - cell.dataset.lastEnter < 500)) {
                row.classList.toggle('fila-seleccionada');
            } else {
                const proximaFila = this.rows[rowIndex + 1];
                if(proximaFila) proximaFila.cells[colIndex].focus();
            }
            cell.dataset.lastEnter = Date.now();
        }
        
        // Navegación con flechas
        if(e.key === "ArrowDown") { e.preventDefault(); this.rows[rowIndex + 1]?.cells[colIndex]?.focus(); }
        if(e.key === "ArrowUp") { e.preventDefault(); this.rows[rowIndex - 1]?.cells[colIndex]?.focus(); }
    });

    // Triple Clic: Color por Booking
    document.getElementById('bBody').addEventListener('click', function(e) {
        if (e.detail === 3) {
            const bookingVal = e.target.parentElement.querySelector('[data-col="booking"]').innerText;
            marcarBookingCompletado(bookingVal);
        }
    });

    function asignarColoresPorBooking() {
        const rows = document.querySelectorAll('#bBody tr');
        let lastBooking = "";
        let colorIndex = 0;
        const colores = ["#ffffff", "#f1f8e9", "#e3f2fd", "#fff3e0", "#f3e5f5"];

        rows.forEach(row => {
            const bCol = row.querySelector('[data-col="booking"]');
            if(!bCol) return;
            const currentBooking = bCol.innerText;
            if (currentBooking !== lastBooking) {
                colorIndex = (colorIndex + 1) % colores.length;
                lastBooking = currentBooking;
            }
            if(currentBooking !== "") row.style.backgroundColor = colores[colorIndex];
        });
    }

    function marcarBookingCompletado(booking) {
        if(!booking) return;
        const rows = document.querySelectorAll('#bBody tr');
        rows.forEach(row => {
            if(row.querySelector('[data-col="booking"]').innerText === booking) {
                row.classList.toggle('booking-completado');
            }
        });
    }

    // 6. FUNCIONES DE BOTONES
    function agregarFila() {
        const tbody = document.getElementById('bBody');
        const num = tbody.rows.length + 1;
        const tr = document.createElement('tr');
        tr.innerHTML = crearFilaHTML({}, num);
        tbody.appendChild(tr);
    }

    function eliminarFila() {
        const sel = document.querySelector('.fila-seleccionada');
        if(sel) sel.remove(); else alert("Haga Doble Enter en una fila para seleccionarla y eliminarla.");
    }

    async function guardarCambios() {
        const rows = document.querySelectorAll('#bBody tr');
        const dataFinal = [];
        let validacion = true;

        rows.forEach(tr => {
            let obj = { semana: SEMANA, dia: DIA };
            tr.querySelectorAll('[data-col]').forEach(td => {
                let col = td.dataset.col;
                let val = td.innerText.trim();
                if(col === "sello_nav" && val === "") validacion = false;
                obj[col] = val;
            });
            if(obj.empresa || obj.booking) dataFinal.push(obj);
        });

        if(!validacion) return alert("El SELLO NAVIERA es obligatorio.");

        const { error: delErr } = await _supabase.from('distribucion_diaria').delete().match({semana: SEMANA, dia: DIA});
        const { error: insErr } = await _supabase.from('distribucion_diaria').insert(dataFinal);
        
        if(!insErr) alert("¡Cambios guardados con éxito!");
        cargarPlanificacion();
    }

    // INICIAR CARGA AL ABRIR
    cargarPlanificacion();

</script>
</body>
</html>
