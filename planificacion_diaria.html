<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Planificación Diaria | Cargo Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-size: 11px; height: 100vh; display: flex; flex-direction: column; background: #f8f9fa; }
        .top-bar { background: #1d6f42; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; }
        .grid-container { flex: 1; overflow: auto; background: white; margin: 5px; border: 1px solid #ccc; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; }
        th { background: #e9ecef; position: sticky; top: 0; z-index: 10; border: 0.5px solid #bbb; padding: 5px; text-align: center; font-weight: bold; }
        td { border: 0.5px solid #ddd; padding: 3px 6px; white-space: nowrap; outline: none; text-overflow: ellipsis; overflow: hidden; cursor: cell; }
        
        /* Estados */
        td:focus { border: 2px solid #0d6efd !important; background: #e8f0fe !important; }
        .fila-seleccionada { background-color: #d1e7dd !important; outline: 2px solid #198754; }
        .booking-completado { background-color: #cff4fc !important; border-left: 5px solid #0dcaf0 !important; }
        .sticky-col { position: sticky; left: 0; background: #f8f9fa; z-index: 5; border-right: 2px solid #ddd; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <button class="btn btn-link text-white p-0 me-2" onclick="window.location.href='cargo_plan_semanal.html'">
            <i class="bi bi-arrow-left-circle-fill fs-5"></i>
        </button>
        <i class="bi bi-calendar3"></i> <b>PLANIFICACIÓN: <span id="txtDia">---</span></b> | 
        SEMANA: <span id="txtSem">---</span>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-light btn-sm" onclick="agregarFila()"><i class="bi bi-plus-lg"></i> Agregar Fila</button>
        <button class="btn btn-danger btn-sm" onclick="eliminarFila()"><i class="bi bi-trash"></i> Eliminar</button>
        <button class="btn btn-warning btn-sm fw-bold" onclick="guardarCambios()"><i class="bi bi-cloud-check"></i> GUARDAR CAMBIOS</button>
    </div>
</div>

<div class="grid-container">
    <table id="mainTable">
        <thead>
            <tr id="hRow">
                <th style="width: 40px;" class="sticky-col">#</th>
                </tr>
        </thead>
        <tbody id="bBody">
            <tr><td colspan="25" class="text-center py-5 text-muted">Cargando distribución...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const DIA = params.get('dia') || 'LUNES';
    const SEMANA = params.get('semana') || '0';

    document.getElementById('txtDia').innerText = DIA.toUpperCase();
    document.getElementById('txtSem').innerText = SEMANA;

    const columnas = [
        "EMPRESA", "PROVEEDOR", "DEPOSITO", "TERMINAL", "BUQUE", 
        "BOOKING", "MARCA", "CODIGO", "PRODUCTOR", "FINCA", 
        "CONTENEDOR", "SELLO_NAV", "SELLO_TCI", "SELLO_VENT", 
        "SELLO_STICKER", "SELLO_STICKER_NAV", "TERMOGRAFO", 
        "CHOFER", "CEDULA", "PLACA", "SUPERVISOR"
    ];

    const hRow = document.getElementById('hRow');
    columnas.forEach(col => {
        let th = document.createElement('th');
        th.style.width = (col === "PRODUCTOR" || col === "PROVEEDOR") ? "180px" : "130px";
        th.innerText = col.replace(/_/g, " ");
        hRow.appendChild(th);
    });

    async function cargarPlanificacion() {
        try {
            const { data, error } = await _supabase
                .from('distribucion_diaria')
                .select('*')
                .match({ semana: SEMANA, dia: DIA })
                .order('booking', { ascending: true });

            if (error) throw error;

            if (data && data.length > 0) {
                let buffer = "";
                data.forEach((reg, index) => {
                    buffer += crearFilaHTML(reg, index + 1);
                });
                document.getElementById('bBody').innerHTML = buffer;
                asignarColoresPorBooking();
            } else {
                document.getElementById('bBody').innerHTML = '<tr><td colspan="25" class="text-center py-5">No hay datos. Importe desde el Dashboard.</td></tr>';
            }
        } catch (err) {
            console.error(err);
        }
    }

    function crearFilaHTML(reg = {}, num) {
        let fila = `<tr><td class="sticky-col text-center bg-light fw-bold">${num}</td>`;
        columnas.forEach(col => {
            let val = reg[col.toLowerCase()] || "";
            fila += `<td contenteditable="true" data-col="${col.toLowerCase()}">${val}</td>`;
        });
        fila += `</tr>`;
        return fila;
    }

    document.getElementById('bBody').addEventListener('keydown', function(e) {
        const cell = e.target;
        const row = cell.parentElement;
        const rowIndex = row.rowIndex - 1;
        const colIndex = cell.cellIndex;

        if (e.key === "Enter") {
            e.preventDefault();
            if (cell.dataset.lastEnter && (Date.now() - cell.dataset.lastEnter < 500)) {
                row.classList.toggle('fila-seleccionada');
            } else {
                const proxima = this.rows[rowIndex + 1];
                if(proxima) proxima.cells[colIndex].focus();
            }
            cell.dataset.lastEnter = Date.now();
        }
        if(e.key === "ArrowDown") { e.preventDefault(); this.rows[rowIndex + 1]?.cells[colIndex]?.focus(); }
        if(e.key === "ArrowUp") { e.preventDefault(); this.rows[rowIndex - 1]?.cells[colIndex]?.focus(); }
    });

    document.getElementById('bBody').addEventListener('click', function(e) {
        if (e.detail === 3) {
            const bVal = e.target.parentElement.querySelector('[data-col="booking"]').innerText;
            if(bVal) marcarBookingCompletado(bVal);
        }
    });

    function asignarColoresPorBooking() {
        const rows = document.querySelectorAll('#bBody tr');
        let lastB = "";
        let colorIdx = 0;
        const colores = ["#ffffff", "#f9fbe7", "#e3f2fd", "#fff3e0", "#f3e5f5"];
        rows.forEach(row => {
            const currentB = row.querySelector('[data-col="booking"]')?.innerText;
            if (currentB && currentB !== lastB) {
                colorIdx = (colorIdx + 1) % colores.length;
                lastB = currentB;
            }
            if(currentB) row.style.backgroundColor = colores[colorIdx];
        });
    }

    function marcarBookingCompletado(booking) {
        document.querySelectorAll('#bBody tr').forEach(row => {
            if(row.querySelector('[data-col="booking"]').innerText === booking) {
                row.classList.toggle('booking-completado');
            }
        });
    }

    function agregarFila() {
        const tbody = document.getElementById('bBody');
        const tr = document.createElement('tr');
        tr.innerHTML = crearFilaHTML({}, tbody.rows.length + 1);
        tbody.appendChild(tr);
    }

    function eliminarFila() {
        const sel = document.querySelector('.fila-seleccionada');
        if(sel) sel.remove(); else alert("Doble Enter en la fila para seleccionar.");
    }

    async function guardarCambios() {
        const rows = document.querySelectorAll('#bBody tr');
        const dataFinal = [];

        rows.forEach(tr => {
            let obj = { semana: SEMANA, dia: DIA };
            tr.querySelectorAll('[data-col]').forEach(td => {
                let col = td.dataset.col;
                let val = td.innerText.trim();
                obj[col] = val;
            });
            // Guardamos la fila siempre que tenga un Booking o Contenedor, sin importar los sellos
            if(obj.booking || obj.contenedor) dataFinal.push(obj);
        });

        // Borramos los registros anteriores del día y subimos los nuevos (aunque falten sellos)
        const { error: delErr } = await _supabase.from('distribucion_diaria').delete().match({semana: SEMANA, dia: DIA});
        const { error: insErr } = await _supabase.from('distribucion_diaria').insert(dataFinal);
        
        if(!insErr) alert("¡Cambios guardados! Ahora otros usuarios pueden completar la información.");
        cargarPlanificacion();
    }

    cargarPlanificacion();
</script>
</body>
</html>
