<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Informe Consolidado | Cargo Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-size: 10px; background: #f4f7f6; font-family: sans-serif; margin: 0; }
        .top-bar { background: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .table-container { margin: 10px; background: white; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: auto; height: calc(100vh - 70px); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #34495e; color: white; position: sticky; top: 0; z-index: 10; padding: 8px; font-size: 9px; border: 1px solid #455a64; text-align: center; }
        td { padding: 4px; border: 1px solid #dee2e6; outline: none; word-wrap: break-word; vertical-align: middle; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        td:focus { background: #fffde7 !important; border: 2px solid #f1c40f !important; }
        .badge-week { background: #e67e22; padding: 4px 8px; border-radius: 4px; }
        .text-blue { color: #0d6efd; font-weight: bold; }
        .bg-readonly { background-color: #f1f3f5; color: #495057; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <button class="btn btn-sm btn-outline-light me-2" onclick="window.history.back()"><i class="bi bi-arrow-left"></i></button>
        <b>INFORME CONSOLIDADO - SEMANA <span id="lblSemana" class="badge-week">---</span></b>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" onclick="cargarInforme()"><i class="bi bi-arrow-clockwise"></i> REFRESCAR</button>
        <button class="btn btn-warning btn-sm fw-bold" onclick="guardarInforme()"><i class="bi bi-cloud-arrow-up"></i> GUARDAR CAMBIOS</button>
        <button class="btn btn-success btn-sm" onclick="exportarExcel()"><i class="bi bi-file-earmark-excel"></i> EXCEL</button>
    </div>
</div>

<div class="table-container">
    <table id="tablaInforme">
        <thead>
            <tr>
                <th style="width: 100px;">EMPRESA</th>
                <th style="width: 100px;">LINEA NAVIERA</th>
                <th style="width: 80px;">MARCA</th>
                <th style="width: 120px;">VAPOR / BUQUE</th>
                <th style="width: 130px;">DAE</th>
                <th style="width: 100px;">AISV</th>
                <th style="width: 120px;">CONTENEDOR</th>
                <th style="width: 110px;">BOOKING</th>
                <th style="width: 85px;">F. CREACIÓN</th>
                <th style="width: 85px;">ENTRADA PTO</th>
                <th style="width: 90px;">PUERTO</th>
                <th style="width: 100px;">DESTINO</th>
                <th style="width: 60px;">CAJAS</th>
                <th style="width: 120px;">CONSOLIDACIÓN</th>
                <th style="width: 140px;">OBSERVACIÓN</th>
            </tr>
        </thead>
        <tbody id="bodyInforme"></tbody>
    </table>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const SEMANA = params.get('semana') || '6';
    document.getElementById('lblSemana').innerText = SEMANA;

    async function cargarInforme() {
        const body = document.getElementById('bodyInforme');
        body.innerHTML = '<tr><td colspan="15" class="text-center py-5">Generando informe...</td></tr>';

        try {
            const { data: daes } = await _supabase.from('reporte_daes').select('*').eq('semana', SEMANA);
            const { data: planif } = await _supabase.from('distribucion_diaria').select('*').eq('semana', SEMANA);
            const { data: informePrevio } = await _supabase.from('informe_contenedores_final').select('*').eq('semana', SEMANA);

            let html = "";
            daes.forEach(d => {
                const cantFilas = parseInt(d.cont || d.contenedor) || 1; 
                const contenedoresAsignados = planif ? planif.filter(p => p.booking === d.booking) : [];

                for (let i = 0; i < cantFilas; i++) {
                    const cReal = contenedoresAsignados[i] || {};
                    const prev = (informePrevio || []).find(ip => ip.booking === d.booking && ip.indice_fila === i) || {};

                    html += `
                        <tr data-booking="${d.booking}" data-indice="${i}">
                            <td class="bg-readonly" data-campo="empresa">${d.empresa || ''}</td>
                            <td contenteditable="true" data-campo="naviera">${prev.naviera || ''}</td>
                            <td contenteditable="true" data-campo="marca">${prev.marca || cReal.marca || ''}</td>
                            <td contenteditable="true" data-campo="vapor">${prev.vapor || d.barco || ''}</td>
                            <td contenteditable="true" data-campo="dae">${prev.dae || d.dae || ''}</td>
                            <td contenteditable="true" data-campo="aisv">${prev.aisv || ''}</td>
                            <td contenteditable="true" data-campo="contenedor" class="text-blue">${prev.contenedor || cReal.contenedor || ''}</td>
                            <td data-campo="booking">${d.booking}</td>
                            <td contenteditable="true" data-campo="fecha_creacion">${prev.fecha_creacion || ''}</td>
                            <td contenteditable="true" data-campo="fecha_puerto">${prev.fecha_puerto || ''}</td>
                            <td contenteditable="true" data-campo="puerto">${prev.puerto || d.terminal || ''}</td>
                            <td contenteditable="true" data-campo="destino">${prev.destino || d.destino || ''}</td>
                            <td contenteditable="true" data-campo="cajas">${prev.cajas || cReal.cajas || ''}</td>
                            <td contenteditable="true" data-campo="campo">${prev.campo || cReal.consolidacion || ''}</td>
                            <td contenteditable="true" data-campo="observacion">${prev.observacion || ''}</td>
                        </tr>
                    `;
                }
            });
            body.innerHTML = html || '<tr><td colspan="15" class="text-center">No hay datos.</td></tr>';
        } catch (err) {
            console.error(err);
            body.innerHTML = '<tr><td colspan="15" class="text-center py-5 text-danger">Error al cargar datos.</td></tr>';
        }
    }

    // NAVEGACIÓN CON FLECHAS
    document.getElementById('bodyInforme').addEventListener('keydown', function(e) {
        const cell = e.target;
        const row = cell.parentElement;
        const rowIndex = Array.from(this.rows).indexOf(row);
        const colIndex = cell.cellIndex;

        if (["ArrowDown", "ArrowUp", "ArrowLeft", "ArrowRight"].includes(e.key)) {
            e.preventDefault();
            if(e.key === "ArrowDown") this.rows[rowIndex + 1]?.cells[colIndex]?.focus();
            if(e.key === "ArrowUp")   this.rows[rowIndex - 1]?.cells[colIndex]?.focus();
            if(e.key === "ArrowRight") cell.nextElementSibling?.focus();
            if(e.key === "ArrowLeft")  cell.previousElementSibling?.focus();
        }
        if (e.key === "Enter") {
            e.preventDefault();
            this.rows[rowIndex + 1]?.cells[colIndex]?.focus();
        }
    });

    async function guardarInforme() {
        const btn = document.querySelector('.btn-warning');
        btn.disabled = true;
        btn.innerHTML = "Guardando...";

        const filas = document.querySelectorAll('#bodyInforme tr');
        const registros = [];

        filas.forEach(tr => {
            registros.push({
                semana: SEMANA,
                booking: tr.dataset.booking,
                indice_fila: parseInt(tr.dataset.indice),
                empresa: tr.querySelector('[data-campo="empresa"]').innerText.trim(),
                naviera: tr.querySelector('[data-campo="naviera"]').innerText.trim(),
                marca: tr.querySelector('[data-campo="marca"]').innerText.trim(),
                vapor: tr.querySelector('[data-campo="vapor"]').innerText.trim(),
                dae: tr.querySelector('[data-campo="dae"]').innerText.trim(),
                aisv: tr.querySelector('[data-campo="aisv"]').innerText.trim(),
                contenedor: tr.querySelector('[data-campo="contenedor"]').innerText.trim(),
                fecha_creacion: tr.querySelector('[data-campo="fecha_creacion"]').innerText.trim(),
                fecha_puerto: tr.querySelector('[data-campo="fecha_puerto"]').innerText.trim(),
                puerto: tr.querySelector('[data-campo="puerto"]').innerText.trim(),
                destino: tr.querySelector('[data-campo="destino"]').innerText.trim(),
                cajas: tr.querySelector('[data-campo="cajas"]').innerText.trim(),
                campo: tr.querySelector('[data-campo="campo"]').innerText.trim(),
                observacion: tr.querySelector('[data-campo="observacion"]').innerText.trim()
            });
        });

        const { error } = await _supabase.from('informe_contenedores_final').upsert(registros, { onConflict: 'semana, booking, indice_fila' });
        
        if (!error) alert("¡Informe guardado!");
        else alert("Error: " + error.message);
        
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> GUARDAR CAMBIOS';
    }

    function exportarExcel() {
        const table = document.getElementById("tablaInforme");
        const blob = new Blob(['\ufeff' + table.outerHTML], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Informe_Semana_${SEMANA}.xls`;
        a.click();
    }

    cargarInforme();
</script>
</body>
</html>
