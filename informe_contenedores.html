<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Informe de Contenedores | Edición Manual</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-size: 11px; background: #f4f7f6; font-family: sans-serif; }
        .top-bar { background: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .table-container { margin: 10px; background: white; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: auto; height: calc(100vh - 100px); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #34495e; color: white; position: sticky; top: 0; z-index: 10; padding: 10px; font-size: 10px; border: 1px solid #455a64; text-align: center; }
        td { padding: 5px; border: 1px solid #dee2e6; outline: none; word-wrap: break-word; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        td[contenteditable="true"]:focus { background: #fffde7; border: 2px solid #f1c40f !important; }
        .col-manual { background-color: #fafffa; }
        .badge-week { background: #e67e22; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <button class="btn btn-sm btn-outline-light me-2" onclick="window.location.href='cargo_plan_semanal.html'"><i class="bi bi-house"></i></button>
        <b>INFORME CONSOLIDADO - SEMANA <span id="lblSemana" class="badge-week">---</span></b>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-warning btn-sm fw-bold" onclick="guardarInforme()"><i class="bi bi-cloud-arrow-up"></i> GUARDAR INFORME</button>
        <button class="btn btn-success btn-sm" onclick="exportarExcel()"><i class="bi bi-file-earmark-excel"></i> EXCEL</button>
    </div>
</div>

<div class="table-container">
    <table id="tablaInforme">
        <thead>
            <tr>
                <th style="width: 100px;">LINEA NAVIERA</th>
                <th style="width: 80px;">MARCA</th>
                <th style="width: 130px;">VAPOR</th>
                <th style="width: 100px;">DAE</th>
                <th style="width: 110px;">CONTENEDOR</th>
                <th style="width: 100px;">BOOKING</th>
                <th style="width: 130px;" class="col-manual">FECHA CREACIÓN</th>
                <th style="width: 130px;" class="col-manual">ENTRADA PUERTO</th>
                <th style="width: 90px;">PUERTO</th>
                <th style="width: 110px;">DESTINOS</th>
                <th style="width: 80px;" class="col-manual">CANT. CAJAS</th>
                <th style="width: 100px;" class="col-manual">CAMPO/CIUDAD</th>
                <th style="width: 150px;" class="col-manual">OBSERVACIÓN</th>
            </tr>
        </thead>
        <tbody id="bodyInforme"></tbody>
    </table>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const SEMANA = params.get('semana') || '6';
    document.getElementById('lblSemana').innerText = SEMANA;

    async function cargarInforme() {
        const body = document.getElementById('bodyInforme');
        body.innerHTML = '<tr><td colspan="13" class="text-center py-5">Sincronizando datos de planificación y DAES...</td></tr>';

        try {
            // 1. Obtener la planificación real (donde están los contenedores asignados y marcas)
            const { data: planif } = await _supabase
                .from('distribucion_diaria')
                .select('booking, contenedor, marca, terminal, consolidacion')
                .eq('semana', SEMANA)
                .not('contenedor', 'is', null)
                .not('contenedor', 'eq', '');

            // 2. Obtener la base de DAES para cruzar por Booking
            const { data: daes } = await _supabase
                .from('cargo_plan_daes')
                .select('*')
                .eq('semana', SEMANA);

            // 3. Obtener datos guardados previamente en este informe
            const { data: informePrevio } = await _supabase
                .from('informe_contenedores_final')
                .select('*')
                .eq('semana', SEMANA);

            if (!planif || planif.length === 0) {
                body.innerHTML = '<tr><td colspan="13" class="text-center py-5">No hay contenedores planificados con número asignado esta semana.</td></tr>';
                return;
            }

            let html = "";
            planif.forEach((p, index) => {
                // BUSQUEDA POR BOOKING: Cruzamos con la tabla de DAES
                const d = daes ? daes.find(item => item.booking === p.booking) : {};
                
                // Buscar si hay datos manuales previos para este contenedor específico
                const prev = (informePrevio || []).find(ip => ip.contenedor === p.contenedor) || {};

                html += `
                    <tr data-booking="${p.booking}" data-contenedor="${p.contenedor}">
                        <td>${d.naviera || ''}</td>
                        <td>${p.marca || ''}</td>
                        <td>${d.vapor || ''}</td>
                        <td>${d.dae || ''}</td>
                        <td class="fw-bold text-primary">${p.contenedor}</td>
                        <td>${p.booking}</td>
                        <td contenteditable="true" class="col-manual" data-campo="fecha_creacion">${prev.fecha_creacion || ''}</td>
                        <td contenteditable="true" class="col-manual" data-campo="fecha_puerto">${prev.fecha_puerto || ''}</td>
                        <td>${p.terminal || d.puerto || ''}</td>
                        <td>${d.destino || ''}</td>
                        <td contenteditable="true" class="col-manual" data-campo="cajas">${prev.cajas || ''}</td>
                        <td contenteditable="true" class="col-manual" data-campo="campo">${prev.campo || p.consolidacion || ''}</td>
                        <td contenteditable="true" class="col-manual" data-campo="observacion">${prev.observacion || ''}</td>
                    </tr>
                `;
            });
            body.innerHTML = html;
        } catch (err) { 
            console.error(err);
            body.innerHTML = '<tr><td colspan="13" class="text-center text-danger">Error al cargar datos.</td></tr>';
        }
    }

    async function guardarInforme() {
        const filas = document.querySelectorAll('#bodyInforme tr');
        const registros = [];

        filas.forEach(tr => {
            const item = {
                semana: SEMANA,
                booking: tr.dataset.booking,
                contenedor: tr.dataset.contenedor,
                fecha_creacion: tr.querySelector('[data-campo="fecha_creacion"]').innerText,
                fecha_puerto: tr.querySelector('[data-campo="fecha_puerto"]').innerText,
                cajas: tr.querySelector('[data-campo="cajas"]').innerText,
                campo: tr.querySelector('[data-campo="campo"]').innerText,
                observacion: tr.querySelector('[data-campo="observacion"]').innerText
            };
            if(item.contenedor) registros.push(item);
        });

        const { error } = await _supabase.from('informe_contenedores_final').upsert(registros, { onConflict: 'semana, contenedor' });
        
        if (!error) alert("¡Informe guardado correctamente!");
        else alert("Error al guardar: " + error.message);
    }

    function exportarExcel() {
        const table = document.getElementById("tablaInforme");
        const html = table.outerHTML;
        const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
        const link = document.createElement("a");
        link.download = `Informe_Semana_${SEMANA}.xls`;
        link.href = url;
        link.click();
    }

    cargarInforme();
</script>
</body>
</html>
