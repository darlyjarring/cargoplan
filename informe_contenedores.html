<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Informe de Contenedores | Edición Total</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-size: 10px; background: #f4f7f6; font-family: sans-serif; }
        .top-bar { background: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .table-container { margin: 10px; background: white; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: auto; height: calc(100vh - 110px); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #34495e; color: white; position: sticky; top: 0; z-index: 10; padding: 8px; font-size: 10px; border: 1px solid #455a64; text-align: center; }
        td { padding: 4px; border: 1px solid #dee2e6; outline: none; word-wrap: break-word; vertical-align: middle; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        td:focus { background: #fffde7 !important; border: 2px solid #f1c40f !important; }
        .badge-week { background: #e67e22; padding: 4px 8px; border-radius: 4px; }
        .text-blue { color: #0d6efd; font-weight: bold; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <button class="btn btn-sm btn-outline-light me-2" onclick="window.location.href='cargo_plan_semanal.html'"><i class="bi bi-house"></i></button>
        <b>INFORME CONSOLIDADO - SEMANA <span id="lblSemana" class="badge-week">---</span></b>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-warning btn-sm fw-bold" onclick="guardarInforme()"><i class="bi bi-cloud-arrow-up"></i> GUARDAR INFORME</button>
        <button class="btn btn-success btn-sm" onclick="exportarExcel()"><i class="bi bi-file-earmark-excel"></i> EXCEL</button>
    </div>
</div>

<div class="table-container">
    <table id="tablaInforme">
        <thead>
            <tr>
                <th style="width: 100px;">LINEA NAVIERA</th>
                <th style="width: 90px;">MARCA</th>
                <th style="width: 130px;">VAPOR / BUQUE</th>
                <th style="width: 110px;">DAE</th>
                <th style="width: 120px;">CONTENEDOR</th>
                <th style="width: 110px;">BOOKING</th>
                <th style="width: 100px;">FECHA CREACIÓN</th>
                <th style="width: 100px;">ENTRADA PUERTO</th>
                <th style="width: 100px;">PUERTO</th>
                <th style="width: 110px;">DESTINO</th>
                <th style="width: 70px;">CANT. CAJAS</th>
                <th style="width: 110px;">CONSOLIDACIÓN</th>
                <th style="width: 150px;">OBSERVACIÓN</th>
            </tr>
        </thead>
        <tbody id="bodyInforme"></tbody>
    </table>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const SEMANA = params.get('semana') || '6';
    document.getElementById('lblSemana').innerText = SEMANA;

    async function cargarInforme() {
        const body = document.getElementById('bodyInforme');
        body.innerHTML = '<tr><td colspan="13" class="text-center py-5">Generando informe desde reporte_daes y planificación diaria...</td></tr>';

        try {
            // 1. Cargar la maestra de DAES (reporte_daes)
            const { data: daes } = await _supabase.from('reporte_daes').select('*').eq('semana', SEMANA);
            
            // 2. Cargar los contenedores reales asignados en la planificación
            const { data: planif } = await _supabase.from('distribucion_diaria').select('*').eq('semana', SEMANA);

            // 3. Cargar datos manuales guardados anteriormente en este informe
            const { data: informePrevio } = await _supabase.from('informe_contenedores_final').select('*').eq('semana', SEMANA);

            if (!daes || daes.length === 0) {
                body.innerHTML = '<tr><td colspan="13" class="text-center py-5">No hay datos en reporte_daes para esta semana.</td></tr>';
                return;
            }

            let html = "";
            daes.forEach(d => {
                // Cantidad de filas a crear por este booking
                const cantFilas = parseInt(d.cont) || 1;
                // Filtrar contenedores que pertenecen a este booking en la planificación
                const contenedoresAsignados = planif ? planif.filter(p => p.booking === d.booking) : [];

                for (let i = 0; i < cantFilas; i++) {
                    const cReal = contenedoresAsignados[i] || {};
                    // Buscar si hay edición manual previa guardada para este booking + indice
                    const prev = (informePrevio || []).find(ip => ip.booking === d.booking && ip.indice_fila === i) || {};

                    html += `
                        <tr data-booking="${d.booking}" data-indice="${i}">
                            <td contenteditable="true" data-campo="naviera">${prev.naviera || d.naviera || ''}</td>
                            <td contenteditable="true" data-campo="marca">${prev.marca || cReal.marca || d.marca || ''}</td>
                            <td contenteditable="true" data-campo="vapor">${prev.vapor || d.vapor || d.buque || ''}</td>
                            <td contenteditable="true" data-campo="dae">${prev.dae || d.dae || ''}</td>
                            <td contenteditable="true" data-campo="contenedor" class="text-blue">${prev.contenedor || cReal.contenedor || ''}</td>
                            <td contenteditable="true" data-campo="booking">${d.booking}</td>
                            <td contenteditable="true" data-campo="fecha_creacion">${prev.fecha_creacion || ''}</td>
                            <td contenteditable="true" data-campo="fecha_puerto">${prev.fecha_puerto || ''}</td>
                            <td contenteditable="true" data-campo="puerto">${prev.puerto || cReal.terminal || d.puerto || ''}</td>
                            <td contenteditable="true" data-campo="destino">${prev.destino || d.destino || ''}</td>
                            <td contenteditable="true" data-campo="cajas">${prev.cajas || ''}</td>
                            <td contenteditable="true" data-campo="campo">${prev.campo || cReal.consolidacion || ''}</td>
                            <td contenteditable="true" data-campo="observacion">${prev.observacion || ''}</td>
                        </tr>
                    `;
                }
            });
            body.innerHTML = html;
        } catch (err) {
            console.error(err);
            body.innerHTML = '<tr><td colspan="13" class="text-center text-danger">Error de conexión con las tablas.</td></tr>';
        }
    }

    async function guardarInforme() {
        const filas = document.querySelectorAll('#bodyInforme tr');
        const registros = [];

        filas.forEach(tr => {
            const item = {
                semana: SEMANA,
                booking: tr.dataset.booking,
                indice_fila: parseInt(tr.dataset.indice),
                naviera: tr.querySelector('[data-campo="naviera"]').innerText,
                marca: tr.querySelector('[data-campo="marca"]').innerText,
                vapor: tr.querySelector('[data-campo="vapor"]').innerText,
                dae: tr.querySelector('[data-campo="dae"]').innerText,
                contenedor: tr.querySelector('[data-campo="contenedor"]').innerText,
                fecha_creacion: tr.querySelector('[data-campo="fecha_creacion"]').innerText,
                fecha_puerto: tr.querySelector('[data-campo="fecha_puerto"]').innerText,
                puerto: tr.querySelector('[data-campo="puerto"]').innerText,
                destino: tr.querySelector('[data-campo="destino"]').innerText,
                cajas: tr.querySelector('[data-campo="cajas"]').innerText,
                campo: tr.querySelector('[data-campo="campo"]').innerText,
                observacion: tr.querySelector('[data-campo="observacion"]').innerText
            };
            registros.push(item);
        });

        const { error } = await _supabase.from('informe_contenedores_final').upsert(registros, { onConflict: 'semana, booking, indice_fila' });
        
        if (!error) alert("¡Informe guardado con todos los cambios!");
        else alert("Error al guardar: " + error.message);
    }

    function exportarExcel() {
        const table = document.getElementById("tablaInforme");
        const html = table.outerHTML;
        window.open('data:application/vnd.ms-excel,' + encodeURIComponent(html));
    }

    cargarInforme();
</script>
</body>
</html>
