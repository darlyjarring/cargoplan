<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Informe de Contenedores | Edición Manual</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-size: 11px; background: #f4f7f6; font-family: sans-serif; }
        .top-bar { background: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .table-container { margin: 10px; background: white; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: auto; height: calc(100vh - 100px); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #34495e; color: white; position: sticky; top: 0; z-index: 10; padding: 10px; font-size: 10px; border: 1px solid #455a64; text-align: center; }
        td { padding: 5px; border: 1px solid #dee2e6; outline: none; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        td[contenteditable="true"]:focus { background: #fffde7; border: 2px solid #f1c40f !important; }
        .col-manual { background-color: #fafffa; } /* Color sutil para identificar campos manuales */
        .badge-week { background: #e67e22; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <button class="btn btn-sm btn-outline-light me-2" onclick="window.location.href='cargo_plan_semanal.html'"><i class="bi bi-house"></i></button>
        <b>INFORME CONSOLIDADO - SEMANA <span id="lblSemana" class="badge-week">---</span></b>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-warning btn-sm fw-bold" onclick="guardarInforme()"><i class="bi bi-cloud-arrow-up"></i> GUARDAR INFORME</button>
        <button class="btn btn-success btn-sm" onclick="exportarExcel()"><i class="bi bi-file-earmark-excel"></i> EXCEL</button>
    </div>
</div>

<div class="table-container">
    <table id="tablaInforme">
        <thead>
            <tr>
                <th style="width: 100px;">LINEA NAVIERA</th>
                <th style="width: 80px;">MARCA</th>
                <th style="width: 130px;">VAPOR</th>
                <th style="width: 100px;">DAE</th>
                <th style="width: 110px;">CONTENEDOR</th>
                <th style="width: 100px;">BOOKING</th>
                <th style="width: 130px;" class="col-manual">FECHA CREACIÓN</th>
                <th style="width: 130px;" class="col-manual">ENTRADA PUERTO</th>
                <th style="width: 90px;">PUERTO</th>
                <th style="width: 110px;">DESTINOS</th>
                <th style="width: 80px;" class="col-manual">CANT. CAJAS</th>
                <th style="width: 100px;" class="col-manual">CAMPO</th>
                <th style="width: 150px;" class="col-manual">OBSERVACIÓN</th>
            </tr>
        </thead>
        <tbody id="bodyInforme">
            </tbody>
    </table>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const SEMANA = params.get('semana') || '6';
    document.getElementById('lblSemana').innerText = SEMANA;

    async function cargarInforme() {
        const body = document.getElementById('bodyInforme');
        body.innerHTML = '<tr><td colspan="13" class="text-center py-5">Generando matriz de contenedores...</td></tr>';

        try {
            // 1. Datos de DAES
            const { data: daes } = await _supabase.from('cargo_plan_daes').select('*').eq('semana', SEMANA);
            // 2. Datos de Planificación (Contenedores reales)
            const { data: planif } = await _supabase.from('distribucion_diaria').select('booking, contenedor').eq('semana', SEMANA).not('contenedor', 'eq', '');
            // 3. Datos previos del Informe (para no perder lo que ya se escribió manual)
            const { data: informePrevio } = await _supabase.from('informe_contenedores_final').select('*').eq('semana', SEMANA);

            if (!daes) return body.innerHTML = '<tr><td colspan="13">No hay datos de DAES.</td></tr>';

            let html = "";
            daes.forEach(d => {
                const numFilas = parseInt(d.cont) || 1;
                const contPlanificados = planif ? planif.filter(p => p.booking === d.booking) : [];

                for (let i = 0; i < numFilas; i++) {
                    const contActual = contPlanificados[i]?.contenedor || "";
                    // Buscar si ya existía información manual guardada para este booking y este contenedor (o índice)
                    const prev = (informePrevio || []).find(p => p.booking === d.booking && p.indice_fila === i) || {};

                    html += `
                        <tr data-booking="${d.booking}" data-indice="${i}">
                            <td>${d.naviera || ''}</td>
                            <td>${d.marca || ''}</td>
                            <td>${d.vapor || ''}</td>
                            <td>${d.dae || ''}</td>
                            <td class="fw-bold text-primary">${contActual}</td>
                            <td>${d.booking}</td>
                            <td contenteditable="true" class="col-manual" data-campo="fecha_creacion">${prev.fecha_creacion || ''}</td>
                            <td contenteditable="true" class="col-manual" data-campo="fecha_puerto">${prev.fecha_puerto || ''}</td>
                            <td>${d.puerto || ''}</td>
                            <td>${d.destino || ''}</td>
                            <td contenteditable="true" class="col-manual" data-campo="cajas">${prev.cajas || ''}</td>
                            <td contenteditable="true" class="col-manual" data-campo="campo">${prev.campo || ''}</td>
                            <td contenteditable="true" class="col-manual" data-campo="observacion">${prev.observacion || ''}</td>
                        </tr>
                    `;
                }
            });
            body.innerHTML = html;
        } catch (err) { console.error(err); }
    }

    async function guardarInforme() {
        const filas = document.querySelectorAll('#bodyInforme tr');
        const registros = [];

        filas.forEach(tr => {
            const item = {
                semana: SEMANA,
                booking: tr.dataset.booking,
                indice_fila: parseInt(tr.dataset.indice),
                fecha_creacion: tr.querySelector('[data-campo="fecha_creacion"]').innerText,
                fecha_puerto: tr.querySelector('[data-campo="fecha_puerto"]').innerText,
                cajas: tr.querySelector('[data-campo="cajas"]').innerText,
                campo: tr.querySelector('[data-campo="campo"]').innerText,
                observacion: tr.querySelector('[data-campo="observacion"]').innerText
            };
            registros.push(item);
        });

        const { error } = await _supabase.from('informe_contenedores_final').upsert(registros, { onConflict: 'semana, booking, indice_fila' });
        
        if (!error) alert("¡Informe guardado correctamente!");
        else alert("Error al guardar: " + error.message);
    }

    function exportarExcel() {
        const table = document.getElementById("tablaInforme");
        const html = table.outerHTML;
        window.open('data:application/vnd.ms-excel,' + encodeURIComponent(html));
    }

    cargarInforme();
</script>
</body>
</html>
