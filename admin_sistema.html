<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN SISTEMA | Carga Masiva Cargo Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .admin-card { background: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 2rem; margin-top: 3rem; }
        .log-container { background: #000; color: #00ff00; height: 350px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 4px; border: 1px solid #444; }
        .text-warning { color: #ffca28 !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-card shadow-lg">
        <h2 class="mb-4 text-primary">ADMIN SISTEMA - CARGA MASIVA</h2>
        <p class="text-muted">Actualización selectiva: Solo llena campos vacíos encontrados en el Excel.</p>
        
        <div class="mb-4">
            <label class="form-label">Archivo Excel (Cargo Plan)</label>
            <input type="file" id="excelInput" class="form-control bg-dark text-white border-secondary" accept=".xlsx, .xls">
        </div>

        <div class="d-grid gap-2">
            <button onclick="procesarExcel()" id="btnProcesar" class="btn btn-primary fw-bold">EJECUTAR ACTUALIZACIÓN</button>
        </div>

        <div class="mt-4">
            <h6>Estado del proceso:</h6>
            <div id="log" class="log-container">> Esperando archivo...</div>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');

    function log(msg, type = '') {
        const logDiv = document.getElementById('log');
        let colorClass = '';
        if(type === 'error') colorClass = 'text-danger';
        if(type === 'success') colorClass = 'text-success';
        if(type === 'warning') colorClass = 'text-warning';
        
        logDiv.innerHTML += `<div class="${colorClass}">> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function procesarExcel() {
        const fileInput = document.getElementById('excelInput');
        if (!fileInput.files[0]) return alert("Selecciona un archivo");

        const btn = document.getElementById('btnProcesar');
        btn.disabled = true;
        log("Iniciando procesamiento...", "success");

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                for (const row of rows) {
                    const cont = row.CONTAINER;
                    if (!cont) continue;

                    const { data: dbRow } = await _supabase
                        .from('distribucion_diaria')
                        .select('*')
                        .eq('contenedor', cont)
                        .maybeSingle();

                    if (!dbRow) {
                        log(`Contenedor ${cont}: No existe en DB`, "error");
                        continue;
                    }

                    const upd = {};
                    
                    // Lógica: Si el campo en DB está vacío y existe en el Excel, se agrega al update
                    if (!dbRow.cajas && row.BOXES) upd.cajas = parseInt(row.BOXES);
                    if (!dbRow.sello_nav && row.Bottle_Seal) upd.sello_nav = row.Bottle_Seal;
                    if (!dbRow.sello_tci && row.TCI && row.TCI !== 'N/A') upd.sello_tci = row.TCI;
                    if (!dbRow.sello_sticker_nav && row.Security_Seal) upd.sello_sticker_nav = row.Security_Seal;
                    if (!dbRow.termografo && row.THERMOGRAPH) upd.termografo = row.THERMOGRAPH;
                    
                    // SELLO STICKER: Busca en columnas comunes si existe
                    const excelSticker = row.sello_sticker || row.STICKER || row.S_STICKER;
                    if (!dbRow.sello_sticker && excelSticker) upd.sello_sticker = excelSticker;

                    // Si se encontró al menos un dato para actualizar
                    if (Object.keys(upd).length > 0) {
                        await _supabase.from('distribucion_diaria').update(upd).eq('id', dbRow.id);
                        log(`Contenedor ${cont}: Campos actualizados: ${Object.keys(upd).join(', ')}`, "success");
                    } else {
                        log(`Contenedor ${cont}: Sin datos nuevos para llenar`, "warning");
                    }
                }
                log("PROCESO COMPLETADO", "success");
            } catch (err) {
                log("Error: " + err.message, "error");
            } finally {
                btn.disabled = false;
            }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>
</body>
</html>
