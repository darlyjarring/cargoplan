<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Importador Rápido</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-size: 0.8rem; background: #eee; }
        .contenedor-fijo { height: 85vh; overflow: auto; background: white; border: 1px solid #ccc; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 4px; overflow: hidden; white-space: nowrap; }
        th { background: #333; color: white; position: sticky; top: 0; }
        /* Optimizamos el renderizado del navegador */
        tr { contain: content; height: 25px; }
    </style>
</head>
<body>

<div class="p-2">
    <div class="d-flex justify-content-between mb-2">
        <h6 class="fw-bold">HOJA: <span id="lblDia">...</span> | SEMANA: <span id="lblSemana">...</span></h6>
        <div>
            <input type="file" id="inputExcel" class="d-none" accept=".xlsx, .xls">
            <button class="btn btn-success btn-sm" onclick="document.getElementById('inputExcel').click()">1. CARGAR EXCEL</button>
            <button class="btn btn-primary btn-sm" id="btnGrabar" onclick="grabar()" disabled>2. GRABAR EN BD</button>
        </div>
    </div>

    <div class="contenedor-fijo">
        <table id="tablaPrincipal">
            <thead id="hHead"></thead>
            <tbody id="bBody"></tbody>
        </table>
    </div>
</div>

<script>
const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
const params = new URLSearchParams(window.location.search);
const DIA = params.get('dia') || 'LUNES';
const SEMANA = params.get('semana') || '0';

document.getElementById('lblDia').innerText = DIA;
document.getElementById('lblSemana').innerText = SEMANA;

const titulos = ["EMPRESA", "PROVEEDOR", "DEPOSITO", "TERMINAL", "BUQUE", "BOOKING", "MARCA", "CODIGO", "PRODUCTOR", "FINCA", "CONTENEDOR", "CHOFER", "CEDULA", "PLACA", "SUPERVISOR"];

// Dibujar cabecera una sola vez
document.getElementById('hHead').innerHTML = `<tr>${titulos.map(t => `<th style="width:130px">${t}</th>`).join('')}</tr>`;

document.getElementById('inputExcel').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = function(evt) {
        const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
        const wsName = wb.SheetNames.find(n => n.toUpperCase().includes(DIA.toUpperCase())) || wb.SheetNames[0];
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wsName], {header: 1});

        if (data.length > 0) {
            const headers = data[0].map(h => String(h || "").toUpperCase().trim());
            const rows = data.slice(1);
            
            // --- EL EQUIVALENTE AL FOR-NEXT DE VBA (EN MEMORIA) ---
            // 1. Buscamos los índices de las columnas una sola vez
            const indices = titulos.map(t => headers.findIndex(h => h.includes(t.substring(0,4))));

            // 2. Construimos el String gigante (Buffer)
            let buffer = "";
            for (let i = 0; i < rows.length; i++) {
                if (!rows[i] || rows[i].length < 2) continue; // Ignorar filas vacías
                
                buffer += "<tr>";
                for (let j = 0; j < indices.length; j++) {
                    let celdaVal = indices[j] !== -1 ? rows[i][indices[j]] : "";
                    buffer += `<td contenteditable="true">${celdaVal || ""}</td>`;
                }
                buffer += "</tr>";
            }

            // 3. Inyectamos todo de golpe al DOM
            document.getElementById('bBody').innerHTML = buffer;
            document.getElementById('btnGrabar').disabled = false;
        }
    };
    reader.readAsArrayBuffer(e.target.files[0]);
});

async function grabar() {
    const btn = document.getElementById('btnGrabar');
    btn.disabled = true;
    
    const rows = document.querySelectorAll('#bBody tr');
    const dataAEnviar = Array.from(rows).map(tr => {
        const c = tr.cells;
        return {
            semana: SEMANA, dia: DIA,
            empresa: c[0].innerText, proveedor: c[1].innerText, deposito: c[2].innerText,
            terminal: c[3].innerText, buque: c[4].innerText, booking: c[5].innerText,
            marca: c[6].innerText, codigo: c[7].innerText, productor: c[8].innerText,
            finca: c[9].innerText, contenedor: c[10].innerText, chofer: c[11].innerText,
            cedula: c[12].innerText, placa: c[13].innerText, supervisor: c[14].innerText
        };
    });

    try {
        // Borrar anterior del día y cargar nuevo
        await _supabase.from('distribucion_diaria').delete().match({semana: SEMANA, dia: DIA});
        const { error } = await _supabase.from('distribucion_diaria').insert(dataAEnviar);
        if (error) throw error;
        alert("¡Guardado correctamente!");
        window.close();
    } catch (err) {
        alert("Error: " + err.message);
        btn.disabled = false;
    }
}
</script>
</body>
</html>
