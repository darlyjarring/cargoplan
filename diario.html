<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editor Pro | Cargo Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-size: 12px; background: #f4f4f4; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .toolbar { background: #1d6f42; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; }
        .grid-container { flex-grow: 1; overflow: auto; background: white; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th { background: #e2e2e2; position: sticky; top: 0; z-index: 10; border: 1px solid #bbb; padding: 5px; text-align: center; }
        td { border: 1px solid #ccc; padding: 3px 6px; white-space: nowrap; outline: none; text-overflow: ellipsis; overflow: hidden; }
        td:focus { background: #fffde7 !important; border: 2px solid #1d6f42 !important; }
        tr:nth-child(even) { background: #f9f9f9; }
    </style>
</head>
<body>

<div class="toolbar">
    <div>
        <i class="bi bi-grid-3x3"></i> <b><span id="txtDia">---</span></b> | SEMANA: <span id="txtSem">---</span>
    </div>
    <div class="d-flex gap-2">
        <input type="file" id="upExcel" class="d-none" accept=".xlsx, .xls">
        <button class="btn btn-light btn-sm" onclick="document.getElementById('upExcel').click()"><i class="bi bi-file-excel"></i> Importar</button>
        <button class="btn btn-light btn-sm" onclick="agregarFila()"><i class="bi bi-plus-circle"></i> Fila</button>
        <button class="btn btn-warning btn-sm fw-bold" id="btnGrabar" onclick="grabarTodo()"> <i class="bi bi-save"></i> GRABAR SEMANA</button>
    </div>
</div>

<div class="grid-container">
    <table id="tblData">
        <thead><tr id="hRow"></tr></thead>
        <tbody id="bBody"></tbody>
    </table>
</div>

<script>
const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
const params = new URLSearchParams(window.location.search);
const DIA = params.get('dia') || 'LUNES';
const SEMANA = params.get('semana') || '0';

document.getElementById('txtDia').innerText = DIA.toUpperCase();
document.getElementById('txtSem').innerText = SEMANA;

const columnas = ["EMPRESA", "PROVEEDOR", "DEPOSITO", "TERMINAL", "BUQUE", "BOOKING", "MARCA", "CODIGO", "PRODUCTOR", "FINCA", "CONTENEDOR", "CHOFER", "CEDULA", "PLACA", "SUPERVISOR"];
document.getElementById('hRow').innerHTML = columnas.map(c => `<th style="width:130px">${c}</th>`).join('');

// --- CARGA RÁPIDA (FOR NEXT MEMORY) ---
document.getElementById('upExcel').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = function(evt) {
        const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames.find(n => n.toUpperCase().includes(DIA.toUpperCase())) || wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, {header: 1});

        if(data.length > 0) {
            const headers = data[0].map(h => String(h || "").toUpperCase().trim());
            const idxs = columnas.map(c => headers.findIndex(h => h.includes(c.substring(0,4))));
            
            let html = "";
            for(let i=1; i<data.length; i++) {
                if(!data[i][idxs[0]] && !data[i][idxs[5]]) continue; // Evitar basura
                html += `<tr>${idxs.map(ci => `<td contenteditable="true">${data[i][ci] || ""}</td>`).join('')}</tr>`;
            }
            document.getElementById('bBody').innerHTML = html;
            initNavegacion();
        }
    };
    reader.readAsArrayBuffer(e.target.files[0]);
});

function agregarFila() {
    const tr = document.createElement('tr');
    tr.innerHTML = columnas.map(() => `<td contenteditable="true"></td>`).join('');
    document.getElementById('bBody').appendChild(tr);
    initNavegacion();
}

// --- NAVEGACIÓN TIPO EXCEL (FLECHAS Y ENTER) ---
function initNavegacion() {
    const cells = document.querySelectorAll('td[contenteditable="true"]');
    cells.forEach(cell => {
        cell.onkeydown = function(e) {
            const col = this.cellIndex;
            const row = this.parentElement.rowIndex - 1;
            const tbody = document.getElementById('bBody');

            if (e.key === "ArrowRight") { e.preventDefault(); this.nextElementSibling?.focus(); }
            if (e.key === "ArrowLeft") { e.preventDefault(); this.previousElementSibling?.focus(); }
            if (e.key === "ArrowDown" || e.key === "Enter") { 
                e.preventDefault(); 
                tbody.rows[row + 1]?.cells[col]?.focus(); 
            }
            if (e.key === "ArrowUp") { 
                e.preventDefault(); 
                tbody.rows[row - 1]?.cells[col]?.focus(); 
            }
        };
    });
}

async function grabarTodo() {
    const btn = document.getElementById('btnGrabar');
    btn.disabled = true;
    btn.innerText = "PROCESANDO...";

    const rows = Array.from(document.querySelectorAll('#bBody tr')).map(tr => {
        const c = tr.cells;
        return {
            semana: SEMANA, dia: DIA,
            empresa: c[0].innerText, proveedor: c[1].innerText, deposito: c[2].innerText,
            terminal: c[3].innerText, buque: c[4].innerText, booking: c[5].innerText,
            marca: c[6].innerText, codigo: c[7].innerText, productor: c[8].innerText,
            finca: c[9].innerText, contenedor: c[10].innerText, chofer: c[11].innerText,
            cedula: c[12].innerText, placa: c[13].innerText, supervisor: c[14].innerText
        };
    });

    try {
        // 1. Guardar en tabla Diaria
        await _supabase.from('distribucion_diaria').delete().match({semana: SEMANA, dia: DIA});
        await _supabase.from('distribucion_diaria').insert(rows);

        // 2. Sincronizar con SABANA SEMANAL (Consolidado)
        // Nota: Aquí se ordenarán por booking automáticamente al consultar
        await _supabase.from('sabana_semanal').delete().match({semana: SEMANA, dia: DIA});
        const { error } = await _supabase.from('sabana_semanal').insert(rows);

        if (error) throw error;
        alert("Sincronizado con Éxito en Sábana Semanal");
        window.close();
    } catch (err) {
        alert("Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "REINTENTAR";
    }
}
</script>
</body>
</html>
