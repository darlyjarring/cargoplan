<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Importador de Datos | Cargo Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-size: 0.85rem; background: #f4f7f6; }
        .header-excel { background: #1d6f42; color: white; padding: 10px 20px; }
        .preview-container { margin: 20px; background: white; border-radius: 8px; border: 1px solid #ccc; height: 70vh; overflow: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #343a40; color: white; position: sticky; top: 0; padding: 10px; border: 1px solid #454d55; }
        td { border: 1px solid #eee; padding: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; color: white; flex-direction: column; }
        /* Estilo para el estado bloqueado */
        .bloqueado { background: #fee2e2 !important; border-color: #ef4444 !important; }
        .msg-bloqueo { display: none; color: #dc3545; font-weight: bold; margin-left: 15px; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="spinner-border text-light"></div>
    <h5 class="mt-3" id="loaderText">Procesando...</h5>
</div>

<div class="header-excel d-flex justify-content-between align-items-center" id="barraSuperior">
    <div>
        <i class="bi bi-file-earmark-excel"></i> <b>IMPORTAR: <span id="lblDia">---</span></b>
        <span id="msgBloqueado" class="msg-bloqueo"><i class="bi bi-lock-fill"></i> DÍA BLOQUEADO (YA GRABADO)</span>
    </div>
    <div class="d-flex gap-2">
        <input type="file" id="inputExcel" class="d-none" accept=".xlsx, .xls">
        <button id="btnSeleccionar" class="btn btn-light btn-sm fw-bold" onclick="document.getElementById('inputExcel').click()">SELECCIONAR EXCEL</button>
        <button class="btn btn-warning btn-sm fw-bold" id="btnGrabar" onclick="grabarDatos()" disabled>GRABAR DATOS</button>
    </div>
</div>

<div class="preview-container">
    <table id="tablaPreview">
        <thead><tr id="hRow"></tr></thead>
        <tbody id="bBody">
            <tr><td colspan="15" class="text-center py-5">Cargue un archivo para previsualizar...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const PROJECT_URL = 'https://vqxdmmtashwloobkhbva.supabase.co';
    const PROJECT_KEY = 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC';
    const _supabase = supabase.createClient(PROJECT_URL, PROJECT_KEY);

    const params = new URLSearchParams(window.location.search);
    const DIA = params.get('dia') || 'LUNES';
    const SEMANA = params.get('semana') || '0';

    document.getElementById('lblDia').innerText = DIA.toUpperCase();

    const titulos = ["EMPRESA", "PROVEEDOR", "DEPOSITO", "TERMINAL", "BUQUE", "BOOKING", "MARCA", "CODIGO", "PRODUCTOR", "FINCA", "CONTENEDOR", "CHOFER", "CEDULA", "PLACA", "SUPERVISOR"];
    document.getElementById('hRow').innerHTML = titulos.map(t => `<th style="width:140px">${t}</th>`).join('');

    let datosParaBD = [];

    // --- 1. FUNCIÓN QUE VERIFICA BLOQUEO AL CARGAR ---
    async function verificarEstado() {
        const { data, error } = await _supabase
            .from('distribucion_diaria')
            .select('id')
            .match({ semana: SEMANA, dia: DIA })
            .limit(1);

        if (data && data.length > 0) {
            // Si hay datos, bloqueamos todo
            document.getElementById('btnSeleccionar').disabled = true;
            document.getElementById('btnGrabar').disabled = true;
            document.getElementById('msgBloqueado').style.display = 'inline';
            document.getElementById('barraSuperior').classList.add('bloqueado');
            document.getElementById('bBody').innerHTML = `<tr><td colspan="15" class="text-center py-5 text-danger fw-bold">ESTE DÍA YA FUE GRABADO. PARA MODIFICARLO, DEBE LIBERARLO DESDE EL PANEL DE CONTROL.</td></tr>`;
        }
    }

    // Ejecutar verificación al abrir
    verificarEstado();

    document.getElementById('inputExcel').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array', cellDates: true});
            const sheetName = wb.SheetNames.find(n => n.toUpperCase().includes(DIA.toUpperCase())) || wb.SheetNames[0];
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header: 1});

            if(raw.length > 0) {
                const headers = raw[0].map(h => String(h || "").toUpperCase().trim());
                const idxs = titulos.map(t => headers.findIndex(h => h.includes(t.substring(0,4))));
                
                let html = "";
                datosParaBD = [];

                for(let i=1; i<raw.length; i++) {
                    if(!raw[i][idxs[5]] && !raw[i][idxs[10]]) continue; 

                    let filaObjeto = { semana: SEMANA, dia: DIA };
                    html += "<tr>";
                    titulos.forEach((t, j) => {
                        let val = idxs[j] !== -1 ? raw[i][idxs[j]] : "";
                        if(val instanceof Date) val = val.toLocaleDateString();
                        html += `<td>${val || ""}</td>`;
                        filaObjeto[t.toLowerCase()] = String(val || "");
                    });
                    html += "</tr>";
                    datosParaBD.push(filaObjeto);
                }
                document.getElementById('bBody').innerHTML = html;
                document.getElementById('btnGrabar').disabled = false;
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    async function grabarDatos() {
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loaderText').innerText = "Grabando en Base de Datos...";
        const btn = document.getElementById('btnGrabar');
        btn.disabled = true;

        try {
            const TABLA_DIARIA = 'distribucion_diaria';
            const TABLA_SABANA = 'sabana_semanal';

            // Insertar datos (Carga masiva)
            const { error: errIns1 } = await _supabase.from(TABLA_DIARIA).insert(datosParaBD);
            if (errIns1) throw errIns1;

            const { error: errIns2 } = await _supabase.from(TABLA_SABANA).insert(datosParaBD);
            if (errIns2) throw errIns2;

            alert(`¡Grabado con éxito! El día ha sido bloqueado.`);
            window.location.reload(); // Recargamos para que se aplique el bloqueo visual

        } catch (e) {
            alert("Error: " + e.message);
            btn.disabled = false;
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>
</body>
</html>
