<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Distribución Diaria | Importador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-size: 0.8rem; }
        .excel-table { background: white; width: 100%; border-collapse: collapse; }
        .excel-table th { background: #343a40; color: white; border: 1px solid #454d55; padding: 8px; position: sticky; top: 0; z-index: 10; }
        .excel-table td { border: 1px solid #dee2e6; padding: 4px; outline: none; min-width: 100px; }
        .modificado { background-color: #fff9c4 !important; }
        .btn-import { background-color: #1d6f42; color: white; } /* Color Excel */
    </style>
</head>
<body>

<div class="p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Distribución: <span id="lblDia" class="text-primary text-uppercase">---</span> - Sem: <span id="lblSemana">---</span></h4>
        <div class="d-flex gap-2">
            <input type="file" id="inputExcel" class="d-none" accept=".xlsx, .xls">
            <button class="btn btn-sm btn-import" onclick="document.getElementById('inputExcel').click()">
                <i class="bi bi-file-earmark-excel"></i> Importar Excel de Hoy
            </button>
            <button class="btn btn-sm btn-success" onclick="guardarTodo()">
                <i class="bi bi-save"></i> Guardar en BD
            </button>
        </div>
    </div>

    <div class="table-responsive" style="height: 80vh;">
        <table class="excel-table" id="tablaDiaria">
            <thead>
                <tr id="headerRow">
                    </tr>
            </thead>
            <tbody id="bodyDiario"></tbody>
        </table>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const DIA = params.get('dia');
    const SEMANA = params.get('semana');

    // Títulos de tu Macro VBA
    const titulosIdeales = ["EMPRESA", "PROVEEDOR", "DEPOSITO", "TERMINAL", "BUQUE", "BOOKING", "MARCA", "CODIGO", "PRODUCTOR", "FINCA", "CONTENEDOR", "CHOFER", "CEDULA", "PLACA", "SUPERVISOR"];

    document.getElementById('lblDia').innerText = DIA;
    document.getElementById('lblSemana').innerText = SEMANA;
    
    // Generar cabecera
    document.getElementById('headerRow').innerHTML = titulosIdeales.map(t => `<th>${t}</th>`).join('') + '<th></th>';

    // --- LÓGICA DE IMPORTACIÓN (REPLICA TU VBA) ---
    document.getElementById('inputExcel').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Busca la hoja por nombre (ej: "Lunes") igual que tu InputBox
            const ws = workbook.Sheets[DIA];
            if (!ws) return alert("No existe la hoja: " + DIA);

            const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});
            const headers = jsonData[0]; // Fila 1 de Excel
            const rows = jsonData.slice(1); // Datos debajo

            const tablaBody = document.getElementById('bodyDiario');
            tablaBody.innerHTML = ""; // Limpiar

            rows.forEach(rowData => {
                let tr = document.createElement('tr');
                tr.classList.add('modificado'); // Marcar para guardar

                titulosIdeales.forEach(titulo => {
                    // Mapeo Robusto: Busca la columna que COINCIDA con el título ideal
                    let colIdx = headers.findIndex(h => h && h.toString().toUpperCase().includes(titulo.substring(0,3)));
                    let valor = colIdx !== -1 ? rowData[colIdx] : "";
                    
                    let td = document.createElement('td');
                    td.contentEditable = "true";
                    td.innerText = valor || "";
                    tr.appendChild(td);
                });

                tr.innerHTML += `<td class="text-center"><i class="bi bi-trash text-danger" onclick="this.parentElement.parentElement.remove()"></i></td>`;
                tablaBody.appendChild(tr);
            });
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    async function guardarTodo() {
        const filas = document.querySelectorAll('#bodyDiario tr');
        if (filas.length === 0) return alert("No hay datos para guardar.");

        const loadingBtn = document.querySelector('.btn-success');
        loadingBtn.disabled = true;
        
        try {
            const datosParaSubir = Array.from(filas).map(fila => {
                let c = fila.cells;
                return {
                    semana: SEMANA, dia: DIA,
                    empresa: c[0].innerText, proveedor: c[1].innerText, deposito: c[2].innerText,
                    terminal: c[3].innerText, buque: c[4].innerText, booking: c[5].innerText,
                    marca: c[6].innerText, codigo: c[7].innerText, productor: c[8].innerText,
                    finca: c[9].innerText, contenedor: c[10].innerText, chofer: c[11].innerText,
                    cedula: c[12].innerText, placa: c[13].innerText, supervisor: c[14].innerText
                };
            });

            // Primero borramos lo que había de ese día para no duplicar si re-importas
            await _supabase.from('distribucion_diaria').delete().eq('semana', SEMANA).eq('dia', DIA);
            
            // Insertamos todo lo nuevo
            const { error } = await _supabase.from('distribucion_diaria').insert(datosParaSubir);
            if (error) throw error;

            alert("¡Datos de " + DIA + " sincronizados con éxito!");
            window.close(); // Opcional: cerrar al terminar
        } catch (err) {
            alert("Error: " + err.message);
        } finally {
            loadingBtn.disabled = false;
        }
    }
</script>
</body>
</html>
