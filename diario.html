<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Revisión Rápida | Cargo Plan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-size: 0.8rem; height: 100vh; overflow: hidden; }
        .main-container { height: 100vh; display: flex; flex-direction: column; padding: 10px; }
        .table-resizer { flex-grow: 1; overflow: auto; background: white; border: 1px solid #ccc; }
        
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th { background: #eee; position: sticky; top: 0; z-index: 10; border: 1px solid #ddd; padding: 8px; font-weight: bold; }
        td { border: 1px solid #ddd; padding: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        td:focus { outline: 2px solid #0d6efd; background: #f0f7ff !important; }

        .btn-excel { background: #1d6f42; color: white; font-weight: bold; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="spinner-border text-success mb-2"></div>
    <b>PROCESANDO DATOS...</b>
</div>

<div class="main-container">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="m-0 fw-bold text-uppercase">Hoja: <span id="lblDia" class="text-success">---</span> | Sem: <span id="lblSemana">---</span></h6>
        <div>
            <input type="file" id="inputExcel" class="d-none" accept=".xlsx, .xls">
            <button class="btn btn-excel btn-sm" onclick="document.getElementById('inputExcel').click()">
                <i class="bi bi-file-earmark-excel"></i> 1. CARGAR
            </button>
            <button class="btn btn-primary btn-sm ms-2" id="btnGuardar" onclick="guardarTodo()" disabled>
                <i class="bi bi-cloud-arrow-up"></i> 2. GRABAR
            </button>
        </div>
    </div>

    <div class="table-resizer">
        <table id="mainTable">
            <thead><tr id="hRow"></tr></thead>
            <tbody id="bRows">
                <tr><td colspan="15" class="text-center py-5 text-muted">Esperando archivo...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const params = new URLSearchParams(window.location.search);
    const DIA = params.get('dia') || 'LUNES';
    const SEMANA = params.get('semana') || '0';

    document.getElementById('lblDia').innerText = DIA;
    document.getElementById('lblSemana').innerText = SEMANA;

    const columnas = ["EMPRESA", "PROVEEDOR", "DEPOSITO", "TERMINAL", "BUQUE", "BOOKING", "MARCA", "CODIGO", "PRODUCTOR", "FINCA", "CONTENEDOR", "CHOFER", "CEDULA", "PLACA", "SUPERVISOR"];
    document.getElementById('hRow').innerHTML = columnas.map(c => `<th style="width:140px">${c}</th>`).join('');

    document.getElementById('inputExcel').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('loader').style.display = 'flex';

        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data, {type: 'array', cellDates: true});
            
            // Buscar hoja exacta o parecida
            const sn = wb.SheetNames.find(n => n.toUpperCase().includes(DIA.toUpperCase())) || wb.SheetNames[0];
            const ws = wb.Sheets[sn];
            const raw = XLSX.utils.sheet_to_json(ws, {header: 1});

            if (raw.length > 0) {
                const headers = raw[0].map(h => String(h || "").toUpperCase().trim());
                const rows = raw.slice(1);
                
                // Mapeo de índices (equivalente a tu Match en VBA)
                const indices = columnas.map(col => headers.findIndex(h => h.includes(col.substring(0,4))));

                // --- EL "FOR NEXT" ULTRA RÁPIDO ---
                let htmlBuffer = "";
                for (let i = 0; i < rows.length; i++) {
                    if (!rows[i] || rows[i].length === 0) continue;
                    
                    htmlBuffer += "<tr>";
                    for (let j = 0; j < indices.length; j++) {
                        let val = indices[j] !== -1 ? rows[i][indices[j]] : "";
                        htmlBuffer += `<td contenteditable="true">${val || ""}</td>`;
                    }
                    htmlBuffer += "</tr>";
                }

                document.getElementById('bRows').innerHTML = htmlBuffer;
                document.getElementById('btnGuardar').disabled = false;
            }
            document.getElementById('loader').style.display = 'none';
        };
        reader.readAsArrayBuffer(file);
    });

    async function guardarTodo() {
        const btn = document.getElementById('btnGuardar');
        btn.disabled = true;
        btn.innerHTML = "GRABANDO...";

        const rows = document.querySelectorAll('#bRows tr');
        const finalData = [];

        rows.forEach(tr => {
            const c = tr.cells;
            finalData.push({
                semana: SEMANA, dia: DIA,
                empresa: c[0].innerText, proveedor: c[1].innerText, deposito: c[2].innerText,
                terminal: c[3].innerText, buque: c[4].innerText, booking: c[5].innerText,
                marca: c[6].innerText, codigo: c[7].innerText, productor: c[8].innerText,
                finca: c[9].innerText, contenedor: c[10].innerText, chofer: c[11].innerText,
                cedula: c[12].innerText, placa: c[13].innerText, supervisor: c[14].innerText
            });
        });

        try {
            // Borrado y Carga Masiva
            await _supabase.from('distribucion_diaria').delete().eq('semana', SEMANA).eq('dia', DIA);
            const { error } = await _supabase.from('distribucion_diaria').insert(finalData);
            if (error) throw error;

            alert("Grabado con éxito");
            window.close();
        } catch (err) {
            alert("Error: " + err.message);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
