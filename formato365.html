<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>COMERSUR | Cargo Plan Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --excel-border: #d1d1d1; --excel-selected: #107c41; --header-bg: #f3f2f1; }
        body { margin: 0; background: #f3f2f1; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .excel-toolbar { background: white; border-bottom: 1px solid var(--excel-border); padding: 8px 15px; display: flex; align-items: center; gap: 10px; }
        .excel-viewport { flex: 1; overflow: auto; background: white; }
        table { border-collapse: collapse; table-layout: fixed; width: max-content; }
        .col-A { width: 35px; } .col-B { width: 140px; } .col-C { width: 100px; } .col-D { width: 230px; } 
        .col-E { width: 150px; } .col-F { width: 130px; } .col-G { width: 110px; } .col-H { width: 130px; }
        .col-I { width: 100px; } .col-J { width: 110px; } .col-K { width: 130px; } .col-L { width: 220px; }
        .col-M { width: 130px; } .col-N { width: 130px; } .col-O { width: 110px; } .col-P { width: 260px; }
        .col-Q { width: 180px; } .col-R { width: 130px; }
        td { border: 0.5px solid var(--excel-border); padding: 0 5px; font-size: 11px; outline: none; white-space: nowrap; vertical-align: middle; height: 25px; }
        td:focus { border: 2px solid var(--excel-selected) !important; background: #fff; z-index: 10; position: relative; }
        .row-label { background: var(--header-bg); text-align: center; color: #666; width: 35px; border-right: 1px solid #c0c0c0; }
        .col-label { background: var(--header-bg); text-align: center; color: #666; height: 22px; }
        .header-9 { font-weight: bold; text-align: center; background: #f8f9fa; border: 1px solid #000 !important; }
        .tabs-footer { background: #f3f2f1; border-top: 1px solid var(--excel-border); display: flex; height: 35px; }
        .tab-item { padding: 5px 20px; background: white; border-right: 1px solid var(--excel-border); font-size: 12px; cursor: pointer; display: flex; align-items: center; }
        .tab-item.active { border-bottom: 3px solid var(--excel-selected); color: var(--excel-selected); font-weight: bold; }
    </style>
</head>
<body>

<div class="excel-toolbar">
    <input type="text" id="txtSemana" class="form-control form-control-sm w-auto" placeholder="Semana">
    <button onclick="buscarDatos()" class="btn btn-sm btn-primary">Cargar Datos</button>
    <select id="selBuque" class="form-select form-select-sm w-auto" disabled onchange="cargarPuertos()"><option>Nave...</option></select>
    <select id="selPuerto" class="form-select form-select-sm w-auto" disabled onchange="generarTodo()"><option>Puerto...</option></select>
</div>

<div class="excel-viewport">
    <table id="excel-table">
        <thead><tr id="head-letters" class="col-label"></tr></thead>
        <tbody id="grid-body"></tbody>
    </table>
</div>

<div class="tabs-footer" id="tabs-bar"><div class="tab-item active">MASTER</div></div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const cols = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R'];
    let fullData = [];
    let masterMap = {}; 

    function init() {
        const head = document.getElementById('head-letters');
        const body = document.getElementById('grid-body');
        head.innerHTML = `<td></td>` + cols.map(c => `<td class="col-${c}">${c}</td>`).join('');
        for (let i = 1; i <= 60; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="row-label">${i}</td>` + 
                cols.map(c => `<td id="cell-${i}-${c}" data-row="${i}" data-col="${c}" contenteditable="true" tabindex="0"></td>`).join('');
            body.appendChild(tr);
        }
        dibujarEsqueleto();
        setupNavigation();
    }

    function normalizarPuerto(p) {
        if (!p) return "";
        const u = p.toUpperCase();
        if (u.includes("NAPORTEC")) return "NAPORTEC";
        if (u.includes("TPG") || u.includes("INARPI")) return "TPG";
        if (u.includes("POSORJA") || u.includes("DP WORLD")) return "POSORJA";
        if (u.includes("CONTECON") || u.includes("CGSA")) return "CONTECON";
        return p;
    }

    async function buscarDatos() {
        const sem = document.getElementById('txtSemana').value;
        const { data, error } = await _supabase.from('distribucion_diaria').select('*').eq('semana', sem);
        if (error) return console.error(error);
        
        fullData = data || [];
        masterMap = {};

        // L처gica de vinculaci처n: Escaneamos por Booking
        fullData.forEach(r => {
            const bk = r.booking ? r.booking.trim() : null;
            if (bk) {
                if (!masterMap[bk]) masterMap[bk] = { dae: '', cliente: '', destino: '' };
                // Solo actualizamos si el campo tiene contenido
                if (r.dae && r.dae !== 'DAE') masterMap[bk].dae = r.dae;
                if (r.cliente && r.cliente !== 'CLIENTE') masterMap[bk].cliente = r.cliente;
                if (r.destino && r.destino !== 'DESTINO') masterMap[bk].destino = r.destino;
            }
        });

        const buques = [...new Set(fullData.map(d => d.vapor || d.barco || d.nave))].filter(Boolean);
        const sel = document.getElementById('selBuque');
        sel.innerHTML = '<option>Nave...</option>' + buques.map(b => `<option value="${b}">${b}</option>`).join('');
        sel.disabled = false;
    }

    function cargarPuertos() {
        const buq = document.getElementById('selBuque').value;
        const puertos = [...new Set(fullData.filter(d => (d.vapor||d.barco||d.nave) === buq).map(d => normalizarPuerto(d.puerto || d.terminal)))].filter(Boolean);
        const sel = document.getElementById('selPuerto');
        sel.innerHTML = '<option>Puerto...</option>' + puertos.map(p => `<option value="${p}">${p}</option>`).join('');
        sel.disabled = false;
    }

    function generarTodo() {
        const buq = document.getElementById('selBuque').value;
        const pto = document.getElementById('selPuerto').value;
        const filtrado = fullData.filter(d => (d.vapor||d.barco||d.nave) === buq && normalizarPuerto(d.puerto||d.terminal) === pto);
        limpiarYTabular(filtrado);
        crearTabs(filtrado);
    }

    function limpiarYTabular(datos) {
        for(let r=10; r<=60; r++) cols.forEach(c => setCelda(r, c, ''));
        if(!datos.length) return;

        // Info de Cabecera tomada del primer registro con datos
        const primerBooking = datos[0].booking ? datos[0].booking.trim() : '';
        const infoM = masterMap[primerBooking] || {};

        setCelda(5, 'C', document.getElementById('selBuque').value);
        setCelda(5, 'I', document.getElementById('txtSemana').value);
        setCelda(5, 'L', infoM.cliente || "S/N"); 
        setCelda(6, 'C', document.getElementById('selPuerto').value);
        setCelda(7, 'L', 'BANANAS');
        setCelda(8, 'L', infoM.destino || "S/N");

        datos.forEach((reg, i) => {
            const r = 10 + i;
            const bk = reg.booking ? reg.booking.trim() : '';
            const master = masterMap[bk] || {};

            setCelda(r, 'A', i + 1); 
            setCelda(r, 'B', reg.contenedor); 
            setCelda(r, 'C', reg.cajas);
            setCelda(r, 'D', master.dae || reg.dae); // Vinculaci처n forzada por Booking
            setCelda(r, 'E', bk);
            setCelda(r, 'F', reg.sello_nav); 
            setCelda(r, 'G', reg.sello_vent);
            setCelda(r, 'H', reg.sello_sticker); 
            setCelda(r, 'I', reg.sello_tci);
            setCelda(r, 'J', reg.sello_sticker_nav); 
            setCelda(r, 'K', reg.termografo);
            setCelda(r, 'L', reg.marca); 
            setCelda(r, 'N', reg.fecha);
            setCelda(r, 'O', reg.codigo_productor);
            setCelda(r, 'P', reg.productor);
        });
    }

    function setupNavigation() {
        document.addEventListener('keydown', (e) => {
            const active = document.activeElement;
            if (active.tagName !== 'TD') return;
            let r = parseInt(active.dataset.row), cIdx = cols.indexOf(active.dataset.col);
            if (e.key === 'ArrowRight' || e.key === 'Tab') { e.preventDefault(); focusCell(r, cols[cIdx + 1]); }
            if (e.key === 'ArrowLeft') { e.preventDefault(); focusCell(r, cols[cIdx - 1]); }
            if (e.key === 'ArrowDown' || e.key === 'Enter') { e.preventDefault(); focusCell(r + 1, cols[cIdx]); }
            if (e.key === 'ArrowUp') { e.preventDefault(); focusCell(r - 1, cols[cIdx]); }
        });
    }

    function focusCell(r, c) { const el = document.getElementById(`cell-${r}-${c}`); if (el) el.focus(); }
    function dibujarEsqueleto() {
        setCelda(5, 'B', 'VESSEL:'); setCelda(5, 'H', 'WEEK:'); setCelda(5, 'K', 'TYPE OF BOX:');
        setCelda(6, 'B', 'PORT:'); setCelda(7, 'K', 'COMMODITY:'); setCelda(8, 'K', 'DESTINATION:');
        const h = ["N째","Container Number","Amount Of Boxes","Dae","Booking","Main Bottle Seal","Vent Seals","Sticker Seal","TCI Seal","Security Seal","Thermograph","Brand","Observations","Consolidation Date","Producer Codes","Producers","Farm","Inspection"];
        h.forEach((t, i) => { const el = document.getElementById(`cell-9-${cols[i]}`); if(el){ el.innerText=t; el.className='header-9'; } });
    }
    function setCelda(r, c, txt) { const el = document.getElementById(`cell-${r}-${c}`); if(el) el.innerText = txt || ''; }
    function crearTabs(datos) {
        const bar = document.getElementById('tabs-bar');
        bar.innerHTML = '<div class="tab-item active" onclick="generarTodo()">MASTER</div>';
        const grupos = {};
        datos.forEach(r => { const k = `${r.destino} - ${r.marca}`; if(!grupos[k]) grupos[k] = []; grupos[k].push(r); });
        Object.keys(grupos).forEach(k => {
            const div = document.createElement('div'); div.className = 'tab-item'; div.innerText = k;
            div.onclick = () => { document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active')); div.classList.add('active'); limpiarYTabular(grupos[k]); };
            bar.appendChild(div);
        });
    }
    window.onload = init;
</script>
</body>
</html>
