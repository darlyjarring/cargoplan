<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>COMERSUR | Cargo Plan Master (DAE Sync)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --excel-border: #d1d1d1; --excel-selected: #107c41; --header-bg: #f3f2f1; }
        body { margin: 0; background: #f3f2f1; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .excel-toolbar { background: white; border-bottom: 1px solid var(--excel-border); padding: 8px 15px; display: flex; align-items: center; gap: 10px; }
        .excel-viewport { flex: 1; overflow: auto; background: white; }
        table { border-collapse: collapse; table-layout: fixed; width: max-content; }
        .col-A { width: 35px; } .col-B { width: 140px; } .col-C { width: 100px; } .col-D { width: 230px; } 
        .col-E { width: 150px; } .col-F { width: 130px; } .col-G { width: 110px; } .col-H { width: 130px; }
        .col-I { width: 100px; } .col-J { width: 110px; } .col-K { width: 130px; } .col-L { width: 220px; }
        td { border: 0.5px solid var(--excel-border); padding: 0 5px; font-size: 11px; outline: none; white-space: nowrap; vertical-align: middle; height: 25px; }
        td:focus { border: 2px solid var(--excel-selected) !important; background: #fff; z-index: 10; position: relative; }
        .row-label { background: var(--header-bg); text-align: center; color: #666; width: 35px; border-right: 1px solid #c0c0c0; }
        .col-label { background: var(--header-bg); text-align: center; color: #666; height: 22px; }
        .header-9 { font-weight: bold; text-align: center; background: #f8f9fa; border: 1px solid #000 !important; }
        .tabs-footer { background: #f3f2f1; border-top: 1px solid var(--excel-border); display: flex; height: 35px; }
        .tab-item { padding: 5px 20px; background: white; border-right: 1px solid var(--excel-border); font-size: 12px; cursor: pointer; display: flex; align-items: center; }
        .tab-item.active { border-bottom: 3px solid var(--excel-selected); color: var(--excel-selected); font-weight: bold; }
    </style>
</head>
<body>

<div class="excel-toolbar">
    <input type="text" id="txtSemana" class="form-control form-control-sm w-auto" placeholder="Semana">
    <button onclick="buscarDatos()" class="btn btn-sm btn-primary">Cargar Datos</button>
    <select id="selBuque" class="form-select form-select-sm w-auto" disabled onchange="cargarPuertos()"><option>Nave...</option></select>
    <select id="selPuerto" class="form-select form-select-sm w-auto" disabled onchange="generarTodo()"><option>Puerto...</option></select>
</div>

<div class="excel-viewport">
    <table id="excel-table">
        <thead><tr id="head-letters" class="col-label"></tr></thead>
        <tbody id="grid-body"></tbody>
    </table>
</div>

<div class="tabs-footer" id="tabs-bar"><div class="tab-item active">MASTER</div></div>

<script>
    const _supabase = supabase.createClient('https://vqxdmmtashwloobkhbva.supabase.co', 'sb_publishable_seniB_T4zCgrkooZ-Ow9aQ_znLUwvLC');
    const cols = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R'];
    let fullData = [];
    let masterMap = {}; 

    function normalizarPuerto(p) {
        if (!p) return "";
        const u = p.toUpperCase();
        if (u.includes("NAPORTEC")) return "NAPORTEC";
        if (u.includes("TPG") || u.includes("INARPI")) return "TPG";
        if (u.includes("POSORJA") || u.includes("DP WORLD")) return "POSORJA";
        if (u.includes("CONTECON") || u.includes("CGSA")) return "CONTECON";
        return p;
    }

    async function buscarDatos() {
        const sem = document.getElementById('txtSemana').value;
        // 1. Obtener Contenedores
        const { data: contenedores } = await _supabase.from('distribucion_diaria').select('*').eq('semana', sem);
        if (!contenedores) return;

        // 2. Obtener DAEs vinculadas por Booking
        const bookings = [...new Set(contenedores.map(c => c.booking))].filter(Boolean);
        const { data: daes } = await _supabase.from('reporte_daes').select('*').in('booking', bookings);

        masterMap = {};
        if (daes) {
            daes.forEach(d => {
                masterMap[d.booking.trim()] = {
                    dae: d.dae || '',
                    cliente: d.cliente || '',
                    destino: d.puerto_destino || d.destino || ''
                };
            });
        }

        fullData = contenedores;
        const buques = [...new Set(fullData.map(d => d.vapor || d.barco || d.nave))].filter(Boolean);
        const sel = document.getElementById('selBuque');
        sel.innerHTML = '<option>Nave...</option>' + buques.map(b => `<option value="${b}">${b}</option>`).join('');
        sel.disabled = false;
    }

    function cargarPuertos() {
        const buq = document.getElementById('selBuque').value;
        const puertos = [...new Set(fullData.filter(d => (d.vapor||d.barco||d.nave) === buq).map(d => normalizarPuerto(d.puerto || d.terminal)))].filter(Boolean);
        const sel = document.getElementById('selPuerto');
        sel.innerHTML = '<option>Puerto...</option>' + puertos.map(p => `<option value="${p}">${p}</option>`).join('');
        sel.disabled = false;
    }

    function generarTodo() {
        const buq = document.getElementById('selBuque').value;
        const pto = document.getElementById('selPuerto').value;
        const filtrado = fullData.filter(d => (d.vapor||d.barco||d.nave) === buq && normalizarPuerto(d.puerto||d.terminal) === pto);
        limpiarYTabular(filtrado);
    }

    function limpiarYTabular(datos) {
        for(let r=10; r<=60; r++) cols.forEach(c => setCelda(r, c, ''));
        if(!datos.length) return;

        const infoM = masterMap[datos[0].booking.trim()] || {};

        setCelda(5, 'C', document.getElementById('selBuque').value);
        setCelda(5, 'I', document.getElementById('txtSemana').value);
        setCelda(5, 'L', infoM.cliente || ""); // Cliente desde la base de DAEs
        setCelda(6, 'C', document.getElementById('selPuerto').value);
        setCelda(8, 'L', infoM.destino || ""); // Destino desde la base de DAEs

        datos.forEach((reg, i) => {
            const r = 10 + i;
            const m = masterMap[reg.booking.trim()] || {};
            setCelda(r, 'A', i + 1); 
            setCelda(r, 'B', reg.contenedor); 
            setCelda(r, 'C', reg.cajas);
            setCelda(r, 'D', m.dae || ""); // DAE CONECTADA POR BOOKING
            setCelda(r, 'E', reg.booking);
            setCelda(r, 'F', reg.sello_nav); 
            setCelda(r, 'G', reg.sello_vent);
            setCelda(r, 'H', reg.sello_sticker); 
            setCelda(r, 'I', reg.sello_tci);
            setCelda(r, 'J', reg.sello_sticker_nav); 
            setCelda(r, 'K', reg.termografo);
            setCelda(r, 'L', reg.marca); 
            setCelda(r, 'N', reg.fecha);
        });
    }

    function setCelda(r, c, txt) { const el = document.getElementById(`cell-${r}-${c}`); if(el) el.innerText = txt || ''; }
    
    // Iniciar estructura y navegación (Flechas/Enter)
    window.onload = () => {
        const body = document.getElementById('grid-body');
        for (let i = 1; i <= 60; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="row-label">${i}</td>` + 
                cols.map(c => `<td id="cell-${i}-${c}" data-row="${i}" data-col="${c}" contenteditable="true" tabindex="0"></td>`).join('');
            body.appendChild(tr);
        }
        // Navegación similar a Office 365
        document.addEventListener('keydown', (e) => {
            const active = document.activeElement;
            if (active.tagName !== 'TD') return;
            let r = parseInt(active.dataset.row), cIdx = cols.indexOf(active.dataset.col);
            if (e.key === 'ArrowRight' || e.key === 'Tab') { e.preventDefault(); document.getElementById(`cell-${r}-${cols[cIdx+1]}`)?.focus(); }
            if (e.key === 'ArrowLeft') { e.preventDefault(); document.getElementById(`cell-${r}-${cols[cIdx-1]}`)?.focus(); }
            if (e.key === 'ArrowDown' || e.key === 'Enter') { e.preventDefault(); document.getElementById(`cell-${r+1}-${cols[cIdx]}`)?.focus(); }
            if (e.key === 'ArrowUp') { e.preventDefault(); document.getElementById(`cell-${r-1}-${cols[cIdx]}`)?.focus(); }
        });
    };
</script>
</body>
</html>
